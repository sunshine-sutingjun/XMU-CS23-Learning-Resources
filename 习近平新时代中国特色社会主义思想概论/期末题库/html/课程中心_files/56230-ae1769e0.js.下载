(self.webpackChunklms=self.webpackChunklms||[]).push([[56230],{356230:function(t,e,i){var s=i(730381),r=i(496486),a=i(383228),c=i(293789);function n(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var i=[],s=!0,r=!1,a=void 0;try{for(var c,n=t[Symbol.iterator]();!(s=(c=n.next()).done)&&(i.push(c.value),!e||i.length!==e);s=!0);}catch(t){r=!0,a=t}finally{try{s||null==n.return||n.return()}finally{if(r)throw a}}return i}(t,e)||u(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=u(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var s=0,r=function(){};return{s:r,n:function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,n=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return c=t.done,t},e:function(t){n=!0,a=t},f:function(){try{c||null==i.return||i.return()}finally{if(n)throw a}}}}function u(t,e){if(t){if("string"==typeof t)return h(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?h(t,e):void 0}}function h(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=new Array(e);i<e;i++)s[i]=t[i];return s}function v(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return s.min(e.filter(Boolean).map((t=>s(t))))}i(491038),i(682772),i(747042),i(339714),i(132023),i(323123),i(454747);class d{constructor(t){this.url=t.server,this.enableMgsQueryCache=t.enableMgsQueryCache,this.videoViewsCache={},this.videosPlayedCache={},this.videoViewsOfOrgCache={},this.videoStatofOrgCache={},this.courseVideosPlayedCache={},this.courseLessonsPlayedCache={},this.lessonViewsCache={},this.lectureLiveViewsCache={},this.lessonsPlayedCache={},this.lectureLivePlayedCache={},this.courseStudentVisitsCache={},this.courseStudentOnlineVideosCache={},this.courseActivityTypeStudentVisitsCache={},this.countInCourseCache={},this.countInCourseWithParamsCache={},this.departmentVisitsDaysCache={},this.departmentVisitsCache={},this.departmentVisitsTodayCache={},this.departmentVisitsYearCache={},this.courseVisitsDaysCache={},this.courseVisitsCache={},this.courseVisitsTodayCache={},this.courseVisitsYearCache={},this.userCourseVideosVisitsCache={},this.userCourseVisitsCache={},this.userCourseVisitsDaysCache={},this.userCourseVisitsTodayCache={},this.userCourseVisitsYearCache={},this.studentCourseVisitDetailsCache={},this.userCourseActivitiesVisitsDaysCache={},this.userCourseActivitiesVisitsTodayCache={},this.userCourseActivitiesVisitsYearCache={},this.courseActivitiesVisitsDaysCache={},this.courseActivitiesVisitsTodayCache={},this.courseActivitiesVisitsYearCache={},this.activitiesVisitCache={},this.activityVisitCache={},this.studentActivityVisitCache={},this.studentWebLinkViewCache={},this.studentVideoViewCache={},this.studentLessonViewCache={},this.studentLectureLiveViewCache={},this.studentMaterialDownloadCache={},this.studentScormStatCache={},this.studentH5CoursewareStatCache={},this.userMaterialDownloadsCache={},this.courseMaterialDownloadCache={},this.courseWebLinkViewCache={},this.orgVisitsCache={},this.orgVisitsDateRangeCache={},this.orgVisitsDaysCache={},this.orgVisitsTodayCache={},this.orgVisitsYearCache={},this.orgVisitsByBrowserCache={},this.orgVisitsByDateRangeBrowserCache={},this.bulletinVisitsCache={},this.bulletinVisitsDateRangeCache={},this.bulletinVisitsDaysCache={},this.bulletinVisitsTodayCache={},this.bulletinVisitsYearCache={},this.bulletinVisitsStatCache={}}_extractResource(t,e,i){return r.each(e,(function(e){var s=e.user_id,r=e.activity_id;if(null==t[s]&&(t[s]={}),null==t[s][i]&&(t[s][i]={}),null==t[s][i][r]&&(t[s][i][r]={}),"material"===i){var a=e.upload_id;t[s][i][r][a]=(e.data.download_count||0)+(e.data.view_count||0)}else t[s][i][r]=e.data.view_count||0}))}countInCourseWithParams(t,e,i,s){var r=JSON.stringify(e),c="".concat(r).concat(t);c in this.countInCourseWithParamsCache&&i(this.countInCourseWithParamsCache[c]);var n=this._query("courses/".concat(t,"/activities/metrics?types=").concat(r));return a.when(n).then((t=>{i(t)}),s)}countInCourse(t,e){if(!(t in this.countInCourseCache)){var i=this._query("courses/".concat(t,"/activities/metrics?types=").concat(JSON.stringify({material:["user","activity","upload"],web_link:["user","activity"],slide:["user","activity"],lesson:["user","activity"],online_video:["user","activity"]})));return a.when(i).then((i=>{var s={};for(var r in i){var a=i[r];this._extractResource(s,a,r)}return this.countInCourseCache[t]=s,e(s)}),(()=>e({})))}e(this.countInCourseCache[t])}countInCourseWithStudentIds(t,e,i){var s=this._query("courses/".concat(t,"/activities/metrics?user_ids=").concat(e,"&types=").concat(JSON.stringify({material:["user","activity","upload"],web_link:["user","activity"],slide:["user","activity"],lesson:["user","activity"],online_video:["user","activity"],lecture_live:["user","activity"]})));return a.when(s).then((t=>{var e={};for(var s in t){var r=t[s];this._extractResource(e,r,s)}return i(e)}),(()=>i({})))}videoViews(t,e){return this._videoViews(t,e,"online-videos",this.videoViewsCache)}interactionVideoViews(t,e){return this._videoViews(t,e,"interactions",this.videoViewsCache)}lessonViews(t,e){return this._videoViews(t,e,"lessons",this.lessonViewsCache)}lectureLiveViews(t,e){return this._videoViews(t,e,"lecture-live",this.lectureLiveViewsCache)}_videoViews(t,e,i,s){var r="".concat(t,"_").concat(i);if(!(r in s)){var c=this._query("activities/".concat(t,"/").concat(i,"/metrics?group_by=user"));return a.when(c).then((function(t){var a={};return t.forEach((function(t){a[t.user_id]="lecture-live"===i?{lectureLiveDuration:t.data.lecture_live_play_duration||0,lectureLiveViews:t.data.lecture_live_view_count||0,replayViewDuration:t.data.replay_play_duration||0,replayViews:t.data.replay_view_count||0}:{firstView:t.data.first_view,lastView:t.data.last_view,viewDuration:t.data.play_duration||0,views:t.data.view_count||0}})),s[r]=a,e(a)}),(()=>e({})))}e(s[r])}videosViewedOfOrg(t,e){if(!(t in this.videoViewsOfOrgCache)){var i=this._query("orgs/".concat(t,"/online-videos/metrics?time_restrict=day"));return a.when(i).then((i=>{var s={views_today:0,views_this_month:0},r=i[i.length-1];return s.views_today=r.view_count||0,s.views_this_month=0,i.forEach((t=>s.views_this_month+=t.view_count||0)),this.videoViewsOfOrgCache[t]=s,e(s)}),(()=>e({})))}e(this.videoViewsOfOrgCache[t])}videoStatOrg(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.videoStatofOrgCache)){var r=this._query("orgs/".concat(t,"/online-videos/stat?range=").concat(e));return a.when(r).then((t=>i(t)),(()=>i({})))}i(this.videoStatofOrgCache[s])}videosPlayed(t,e){return this._videosPlayed(t,e,"online-videos",this.videosPlayedCache)}courseVideosPlayed(t,e){return this._courseVideosPlayed(t,e,"online-videos",this.courseVideosPlayedCache)}interactionVideosPlayed(t,e){return this._videosPlayed(t,e,"interactions",this.videosPlayedCache)}courseInteractionVideosPlayed(t,e){return this._courseVideosPlayed(t,e,"interactions",this.courseVideosPlayedCache)}lessonsPlayed(t,e){return this._videosPlayed(t,e,"lessons",this.lessonsPlayedCache)}lectureLivePlayed(t,e){return this._videosPlayed(t,e,"lecture-live",this.lectureLivePlayedCache)}courseLessonsPlayed(t,e){return this._courseVideosPlayed(t,e,"lessons",this.courseLessonsPlayedCache)}_courseVideosPlayed(t,e,i,s){var r="".concat(t,"_").concat(i);if(!(r in s)){var c=this._query("courses/".concat(t,"/").concat(i,"/metrics?group_by=course,activity"));return a.when(c).then((function(t){var i={};return t.forEach((function(t){i[t.activity_id]=t.data})),s[r]=i,e(i)}),(()=>e({})))}e(s[r])}_videosPlayed(t,e,i,s){var r="".concat(t,"_").concat(i);if(!(r in s)){var c=this._query("courses/".concat(t,"/").concat(i,"/metrics?group_by=user,activity"));return a.when(c).then((function(t){var a={};return t.forEach((function(t){null==a[t.activity_id]&&(a[t.activity_id]={}),a[t.activity_id][t.user_id]="lecture-live"===i?{lectureLiveViews:t.data.lecture_live_view_count||0,lectureLiveViewDuration:t.data.lecture_live_play_duration||0,replayViews:t.data.replay_view_count||0,replayViewDuration:t.data.replay_play_duration||0}:{views:t.data.view_count||0,viewDuration:t.data.play_duration||0}})),s[r]=a,e(a)}),(()=>e({})))}e(s[r])}courseVideosViewsCustomRange(t,e,i,s,r){var c=(new Date).getTimezoneOffset()/-60,n=this._query("courses/".concat(t,"/online-videos/plays?start=").concat(e,"&end=").concat(i,"&timezone_offset=").concat(c,"&split=").concat(s)),u=this._query("courses/".concat(t,"/interactions/plays?start=").concat(e,"&end=").concat(i,"&timezone_offset=").concat(c,"&split=").concat(s));return a.when(n,u).then((function(t,e){var i,s="success"===t[1]?t[0]:[],a="success"===e[1]?e[0]:[],c={},n=o(s.concat(a));try{for(n.s();!(i=n.n()).done;){var u=i.value;c[u.activity_id]=u.plays}}catch(t){n.e(t)}finally{n.f()}return r(c)}),(t=>r({})))}courseVideosViews(t,e,i,s){var r={day:"hour",week:"day",month:"day",year:"month"},n=this._query("courses/".concat(t,"/online-videos/metrics?group_by=activity,user&time_restrict=").concat(r[e])),u=this._query("courses/".concat(t,"/interactions/metrics?group_by=activity,user&time_restrict=").concat(r[e]));return a.when(n,u).then((function(t,r){var a,n="success"===t[1]?t[0]:[],u="success"===r[1]?r[0]:[],h={},v=o(n.concat(u));try{for(v.s();!(a=v.n()).done;){var d=a.value;if(-1===i.indexOf(d.user_id)){var y,l=[],_=o(d.data);try{for(_.s();!(y=_.n()).done;){var V=y.value,C="play_count"in V?V.play_count:0;l.push(C)}}catch(t){_.e(t)}finally{_.f()}if("week"===e&&(l=l.slice(-7)),d.activity_id in h){var f,m=o(c.range(0,h[d.activity_id].length-1,!0));try{for(m.s();!(f=m.n()).done;){var w=f.value;h[d.activity_id][w]+=l[w]}}catch(t){m.e(t)}finally{m.f()}}else h[d.activity_id]=l}}}catch(t){v.e(t)}finally{v.f()}return s(h)}),(()=>s({})))}courseStudentOnlineVideos(t,e){if(!(t in this.courseStudentOnlineVideosCache)){var i=this._query("courses/".concat(t,"/online-videos/metrics?group_by=activity,user"));return a.when(i).then((i=>{var s={};return i.forEach((function(t){t.data.play_duration&&t.data.play_duration<0&&(t.data.play_duration=0),s[t.user_id]?(s[t.user_id].playCount+=t.data.play_count||0,s[t.user_id].playDuration+=t.data.play_duration||0):s[t.user_id]={playCount:t.data.play_count||0,playDuration:t.data.play_duration||0}})),this.courseStudentOnlineVideosCache[t]=s,e(s)}),(()=>e({})))}e(this.courseStudentOnlineVideosCache[t])}courseStudentOnlineVideosWithStudentIds(t,e,i,s){var r=this._query("courses/".concat(t,"/online-videos/metrics?user_ids=").concat(e,"&group_by=activity,user"));return a.when(r).then((t=>{var e={};return t.forEach((function(t){i.includes(t.activity_id)&&(e[t.user_id]?(e[t.user_id].playCount+=t.data.play_count||0,e[t.user_id].playDuration+=t.data.play_duration||0):e[t.user_id]={playCount:t.data.play_count||0,playDuration:t.data.play_duration||0})})),s(e)}),(()=>s({})))}videoStudentsInterval(t,e,i,s,r,c){var n,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if("custom"===e){var h=(new Date).getTimezoneOffset()/-60;n=this._query("video/".concat(t,"/online-videos/users/intervals?range=").concat(e,"&start=").concat(r,"&end=").concat(c,"&timezone_offset=").concat(h,"&user_ids=").concat(u))}else n=this._query("video/".concat(t,"/online-videos/users/intervals?range=").concat(e,"&user_ids=").concat(u));return a.when(n).then((function(t){var e,s={},r=o(t);try{for(r.s();!(e=r.n()).done;){var a=e.value;s[a._id]=a.intervals}}catch(t){r.e(t)}finally{r.f()}return i(s)}),(t=>s(t.responseJSON)))}lessonStudentsInterval(t,e,i,s,r,c){var n;if("custom"===e){var u=(new Date).getTimezoneOffset()/-60;n=this._query("video/".concat(t,"/lessons/users/intervals?range=").concat(e,"&start=").concat(r,"&end=").concat(c,"&timezone_offset=").concat(u))}else n=this._query("video/".concat(t,"/lessons/users/intervals?range=").concat(e));return a.when(n).then((function(t){var e,s={},r=o(t);try{for(r.s();!(e=r.n()).done;){var a=e.value;s[a._id]=a.intervals}}catch(t){r.e(t)}finally{r.f()}return i(s)}),(t=>s(t.responseJSON)))}interactionVideoStudentsInterval(t,e,i,s,r,c){var n;if("custom"===e){var u=(new Date).getTimezoneOffset()/-60;n=this._query("video/".concat(t,"/interactions/users/intervals?range=").concat(e,"&start=").concat(r,"&end=").concat(c,"&timezone_offset=").concat(u))}else n=this._query("video/".concat(t,"/interactions/users/intervals?range=").concat(e));return a.when(n).then((function(t){var e,s={},r=o(t);try{for(r.s();!(e=r.n()).done;){var a=e.value;s[a._id]=a.intervals}}catch(t){r.e(t)}finally{r.f()}return i(s)}),(t=>s(t.responseJSON)))}courseStudentVisits(t,e){if(!(t in this.courseStudentVisitsCache)){var i=this._query("courses/".concat(t,"/user-visits/metrics?group_by=user"));return a.when(i).then((i=>{var s={};return i.forEach((t=>s[t.user_id]={visits:t.data.count||0,visitDuration:t.data.sum||0,firstVisit:v(t.data.first_visit_start_from,t.data.first_time),lastVisit:t.data.last_time})),this.courseStudentVisitsCache[t]=s,e(s)}),(()=>e({})))}e(this.courseStudentVisitsCache[t])}courseStudentVisitsWithStudentIds(t,e,i){var s=this._query("courses/".concat(t,"/user-visits/metrics?user_ids=").concat(e,"&group_by=user"));return a.when(s).then((t=>{var e={};return t.forEach((t=>e[t.user_id]={visits:t.data.count||0,visitDuration:t.data.sum||0,firstVisit:v(t.data.first_visit_start_from,t.data.first_time),lastVisit:t.data.last_time})),i(e)}),(()=>i({})))}courseZhiyunVisitsWithStudentIds(t,e,i,s){var r=this._query("orgs/".concat(t,"/zhiyun-visits/metrics?user_ids=").concat(i,"&course_ids=").concat(e));return a.when(r).then((t=>{var e={};return t.forEach((t=>{e[t.user_id]={visits:t.data.visits||0}})),s(e)}),(()=>s({})))}courseVideosStudentViews(t,e,i){return this._courseVideosStudentViews(t,e,i,"online-videos",this.studentVideoViewCache)}courseLessonsStudentViews(t,e,i){return this._courseVideosStudentViews(t,e,i,"lessons",this.studentLessonViewCache)}courseLectureLiveStudentViews(t,e,i){return this._courseLiveStudentViews(t,e,i,"lecture-live",this.studentLectureLiveViewCache)}_courseVideosStudentViews(t,e,i,s,r){var c="".concat(t,"_").concat(e);if(!r[c]){var n=this._query("courses/".concat(t,"/users/").concat(e,"/").concat(s,"/metrics?group_by=activity"));return a.when(n).then((function(t){var e={};return t.forEach((t=>e[t.activity_id]={firstView:t.data.first_view,lastView:t.data.last_view,views:t.data.view_count||0,viewDuration:t.data.play_duration||0})),r[c]=e,i(e)}),(()=>i({})))}i(r[c])}_courseLiveStudentViews(t,e,i,s,r){var c="".concat(t,"_").concat(e);if(!r[c]){var n=this._query("courses/".concat(t,"/users/").concat(e,"/").concat(s,"/metrics?group_by=activity"));return a.when(n).then((function(t){var e={};return t.forEach((t=>e[t.activity_id]={lectureLiveViews:t.data.lecture_live_view_count||0,replayViews:t.data.replay_view_count||0,lectureLivePlayDuration:t.data.lecture_live_play_duration||0,replayPlayDuration:t.data.replay_play_duration||0})),r[c]=e,i(e)}),(()=>i({})))}i(r[c])}courseScormStudentStat(t,e,i){var s="".concat(t,"_").concat(e);if(this.studentScormStatCache[s])return this.studentScormStatCache[s];var r=this._query("courses/".concat(t,"/scorm/metrics?group_by=activity&user_ids=").concat(e));return a.when(r).then((t=>{this.studentScormStatCache[s]=t,i(t)}),(()=>{}))}courseH5CoursewareStudentStat(t,e,i){var s="".concat(t,"_").concat(e);if(this.studentH5CoursewareStatCache[s])return this.studentH5CoursewareStatCache[s];var r=this._query("courses/".concat(t,"/h5-courseware/metrics?group_by=activity&user_ids=").concat(e));return a.when(r).then((t=>{this.studentH5CoursewareStatCache[s]=t,i(t)}),(()=>{}))}courseMaterialsStudentDownloads(t,e,i){var s="".concat(t,"_").concat(e);if(!this.studentMaterialDownloadCache[s]){var r=this._query("courses/".concat(t,"/users/").concat(e,"/materials/metrics?group_by=activity,upload"));return a.when(r).then((t=>{var e={};return t.forEach((function(t){var i="".concat(t.activity_id,"_").concat(t.upload_id);return e[i]={downloads:t.data.download_count||0,views:t.data.view_count||0,lastDownload:t.data.last_download,lastView:t.data.last_view}})),this.studentMaterialDownloadCache[s]=e,i(e)}),(()=>i({})))}i(this.studentMaterialDownloadCache[s])}courseMaterialsDownloads(t,e){if(!this.courseMaterialDownloadCache[t]){var i=this._query("courses/".concat(t,"/materials/metrics?group_by=activity,upload,user"));return a.when(i).then((i=>{var s={};return i.forEach((function(t){var e="".concat(t.activity_id,"_").concat(t.upload_id);return null==s[e]&&(s[e]={}),s[e][t.user_id]={downloads:t.data.download_count||0,lastDownload:t.data.last_download,views:t.data.view_count||0,lastView:t.data.last_view}})),this.courseMaterialDownloadCache[t]=s,e(s)}),(()=>e({})))}e(this.courseMaterialDownloadCache[t])}courseWebLinkStudentViews(t,e,i){var s="".concat(t,"_").concat(e);if(!this.studentWebLinkViewCache[s]){var r=this._query("courses/".concat(t,"/users/").concat(e,"/weblinks/metrics?group_by=activity"));return a.when(r).then((t=>{var e={};return t.forEach((t=>e[t.activity_id]={views:t.data.view_count||0,lastView:t.data.last_view})),this.studentWebLinkViewCache[s]=e,i(e)}),(()=>i({})))}i(this.studentWebLinkViewCache[s])}courseWebLinkViews(t,e){if(!this.courseWebLinkViewCache[t]){var i=this._query("courses/".concat(t,"/weblinks/metrics?group_by=activity,user"));return a.when(i).then((i=>{var s={};return i.forEach((function(t){return null==s[t.activity_id]&&(s[t.activity_id]={}),s[t.activity_id][t.user_id]={views:t.data.view_count||0,lastView:t.data.last_view}})),this.courseWebLinkViewCache[t]=s,e(s)}),(()=>e({})))}e(this.courseWebLinkViewCache[t])}studentCourseVisits(t,e,i){var s="".concat(e,"_").concat(t);if(!this.studentCourseVisitDetailsCache[s]){var r=this._query("courses/".concat(e,"/users/").concat(t,"/user-visits"));return a.when(r).then((t=>{var e=[];return t.forEach((function(t){var i={activityId:null==t.activity_id?"":t.activity_id,activityType:t.activity_type||null,groupId:t.group_id,visitTime:t.visit_start_from||t.time,visitDuration:t.visit_duration};return e.push(i)})),this.studentCourseVisitDetailsCache[s]=e,i(e)}),(()=>i({})))}i(this.studentCourseVisitDetailsCache[s])}courseActivitiesStudentVisits(t,e,i){var s="".concat(t,"_").concat(e);if(!this.studentActivityVisitCache[s]){var r=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?group_by=activity,group,type"));return a.when(r).then((t=>{var e={};return t.forEach((function(t){var i="".concat(t.activity_type,"_").concat(t.activity_id);return t.group_id>0&&(i+="_".concat(t.group_id)),e[i]={firstVisit:v(t.data.first_visit_start_from,t.data.first_time),lastVisit:t.data.last_time,visits:t.data.count||0,visitDuration:t.data.sum||0,type:t.activity_type}})),this.studentActivityVisitCache[s]=e,i(e)}),(()=>i({})))}i(this.studentActivityVisitCache[s])}courseStudentActivityTypeVisits(t,e,i,s){var r="course"===e?"user":"user,type";"course"===e&&(e="");var c=this._query("courses/".concat(t,"/user-visits/metrics?user_ids=").concat(i,"&activity_type=").concat(e,"&group_by=").concat(r));return a.when(c).then((t=>{var e={};return t.forEach((t=>e[t.user_id]={firstVisit:v(t.data.first_visit_start_from,t.data.first_time),lastVisit:t.data.last_time,visits:t.data.count||0,visitDuration:t.data.sum||0,type:t.activity_type})),s(e)}),(()=>s({})))}courseVisitsStat(t,e,i,r,c){"course"===e&&(e="");var n=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=").concat(r,"&activity_type=").concat(e));return a.when(n).then((t=>{var e,a,n;"month"===r&&(a=s(s().format("YYYY-MM-DD"))),"month"===r&&(e=a.clone().add(-11,"months"));var o=this._emptyDay(),u=this._emptyDay();return"hour"===r?n=t:"day"===r?n=t.slice(t.length-i,t.length+1):"month"===r&&(n=this._filterVisitsByDate(t,e,a)),n.forEach(((t,e)=>o[e]=t.student_count||0)),n.forEach(((t,e)=>u[e]=t.student_distinct||0)),c({visits:o,visitors:u})}),(()=>c({})))}usersCourseActivityTypeVisits(t,e,i,r,c,n){"course"===c&&(c="");var u=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=").concat(r,"&user_ids=").concat(e,"&activity_type=").concat(c,"&group_by=user"));return a.when(u).then((t=>{var e,a;"month"===r&&(a=s(s().format("YYYY-MM-DD"))),"month"===r&&(e=a.clone().add(-11,"months"));var c,u={},h=o(t);try{for(h.s();!(c=h.n()).done;){var v=c.value,d=[];if("hour"===r)d=v.data;else if("day"===r){u[v.user_id]=this._emptyDays(i);var y=v.data.length;d=v.data.slice(y-i,y+1)}else"month"===r&&(d=this._filterVisitsByDate(v.data,e,a));u[v.user_id]=d.map(((t,e)=>t.student_count||0))}}catch(t){h.e(t)}finally{h.f()}return n(u)}),(()=>n([])))}courseActivitiesVisits(t,e,i){if(!this.activitiesVisitCache[t]){var s=e?"student_":"",r=this._query("courses/".concat(t,"/user-visits/metrics?group_by=activity,group,type"));return a.when(r).then((e=>{var r={};return e.forEach((function(t){var e="".concat(t.activity_type,"_").concat(t.activity_id);return t.group_id>0&&(e+="_".concat(t.group_id)),r[e]={visits:t.data["".concat(s,"count")]||0}})),this.activitiesVisitCache[t]=r,i(r)}),(()=>i({})))}i(this.activitiesVisitCache[t])}activityVisits(t,e,i,s){var c,o="".concat(i,"_").concat(e,"_").concat(t);if(!this.activityVisitCache[o]){if(r.includes(e,"_")){var u=n(Array.from(e.split("_")),2);e=u[0],c=u[1]}else c="null";var h=this._query("courses/".concat(t,"/activities/").concat(e,"/activity-types/").concat(i,"/user-visits/metrics?group=").concat(c,"&group_by=user"));return a.when(h).then((t=>{var e={};return t.forEach((t=>e[t.user_id]={lastVisit:t.data.last_time,visits:t.data.count||0})),this.activityVisitCache[o]=e,s(e)}),(()=>s({})))}s(this.activityVisitCache[o])}userCourseVisits(t,e,i){var s="".concat(e,"_").concat(t);if(!this.userCourseVisitsCache[s]){var r=this._query("courses/".concat(e,"/users/").concat(t,"/user-visits/metrics"));return a.when(r).then((t=>{var e={visits:t.count||0,visitDuration:t.sum||0};return this.userCourseVisitsCache[s]=e,i(e)}),(()=>i({})))}i(this.userCourseVisitsCache[s])}userCourseVideosVisits(t,e,i){var s="".concat(e,"_").concat(t);if(!this.userCourseVideosVisitsCache[s]){var r=this._query("courses/".concat(e,"/users/").concat(t,"/online-videos/metrics?group_by=activity")),c=this._query("courses/".concat(e,"/users/").concat(t,"/interactions/metrics?group_by=activity"));return a.when(r,c).then(((t,e)=>{var r,a={viewCount:0,playCount:0,playDuration:0},c="success"===t[1]?t[0]:[],n="success"===e[1]?e[0]:[],u=o(c.concat(n));try{for(u.s();!(r=u.n()).done;){var h=r.value;h.data&&(a.viewCount+=h.data.view_count||0,a.playCount+=h.data.play_count||0,(null!=h.data.play_duration)>0&&(a.playDuration+=h.data.play_duration))}}catch(t){u.e(t)}finally{u.f()}return this.userCourseVideosVisitsCache[s]=a,i(a)}),(()=>i({})))}i(this.userCourseVideosVisitsCache[s])}userMaterialDownloads(t,e,i){var s="".concat(e,"_").concat(t);if(!this.userMaterialDownloadsCache[s]){var r=this._query("courses/".concat(e,"/users/").concat(t,"/materials/metrics"));return a.when(r).then((t=>{var e={downloads:(t.download_count||0)+(t.view_count||0)};return this.userMaterialDownloadsCache[s]=e,i(e)}),(()=>i({})))}i(this.userMaterialDownloadsCache[s])}_onVisitsQuerySuccess(t,e,i,s){return function(r){var a=r[e]||0;return t[i]=a,s(a)}}_onVisitsDaysQuerySuccess(t,e,i,s,r){return a=>{var c={visits:this._emptyDays(i),visitors:this._emptyDays(i)};return(a=a.slice(a.length-i,a.length+1)).forEach((function(t,e){return c.visits[e]=t["".concat(s,"count")]||0,c.visitors[e]=t["".concat(s,"distinct")]||0})),t[e]=c,r(c)}}_filterVisitsByDate(t,e,i){var r,a=[];if(this._isVisitsByMonth(t)){for(var c=e.get("year"),n=e.get("month")+1,o=i.get("year"),u=i.get("month")+1;c<=o;){for(var h=c<o?12:u;n<=h;){r=s().year(c).month(n-1).date(1).hour(0).minute(0).second(0).format("YYYY/MM/DD HH:mm:ss"),a.push(this._filterVisitByTime(t,r)),n+=1}n=1,c+=1}return a}for(var v=e;i.diff(v,"days")>=0;)r=v.format("YYYY/MM/DD HH:mm:ss"),a.push(this._filterVisitByTime(t,r)),v.add(1,"days");return a}_filterVisitByTime(t,e){var i,s=r.filter(t,(t=>t.time===e));1===s.length?i=s[0]:i=r.find(s,(t=>void 0!==t.count))||{count:0,distinct:0};return i}_isVisitsByMonth(t){if(t.length<2)return!1;var e=s(t[0].time,"YYYY/MM/DD HH:mm");return s(t[1].time,"YYYY/MM/DD HH:mm").diff(e,"days")>27}_onVisitsTodayQuerySuccess(t,e,i,s){return r=>{var a={visits:this._emptyDay(),visitors:this._emptyDay()};return r.forEach((function(t,e){return a.visits[e]=t["".concat(i,"count")]||0,a.visitors[e]=t["".concat(i,"distinct")]||0})),t[e]=a,s(a)}}_onVisitsYearQuerySuccess(t,e,i,r){return a=>{var c={visits:this._emptyYear(),visitors:this._emptyYear()},n=s(s().format("YYYY-MM-DD")),o=n.clone().add(-11,"months");return(a=this._filterVisitsByDate(a,o,n)).forEach((function(t,e){return c.visits[e]=t["".concat(i,"count")]||0,c.visitors[e]=t["".concat(i,"distinct")]||0})),t[e]=c,r(c)}}_emptyYear(){var t=(new Date).getMonth()+1;return r.map(c.range(1,t,!0),(()=>0))}_emptyDays(t){return r.map(c.range(1,t,!0),(()=>0))}_emptyDay(){var t=(new Date).getHours()+1;return r.map(c.range(1,t,!0),(()=>0))}courseVisits(t,e,i){if(!(t in this.courseVisitsCache)){var s=e?"student_":"",r=this._onVisitsQuerySuccess(this.courseVisitsCache,"".concat(s,"count"),t,i),c=this._query("courses/".concat(t,"/user-visits/metrics"));return a.when(c).then(r,(()=>i(0)))}i(this.courseVisitsCache[t])}userCourseVisitsToday(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.userCourseVisitsTodayCache)){var r=this._onVisitsTodayQuerySuccess(this.userCourseVisitsTodayCache,s,"",(t=>i(t.visits||[]))),c=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?time_restrict=hour"));return a.when(c).then(r,(()=>i({})))}i(this.userCourseVisitsTodayCache[s].visits)}courseVisitsToday(t,e,i){if(!(t in this.courseVisitsTodayCache)){var s=e?"student_":"",r=this._onVisitsTodayQuerySuccess(this.courseVisitsTodayCache,t,s,i),c=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=hour"));return a.when(c).then(r,(()=>i({})))}i(this.courseVisitsTodayCache[t])}_onGetCourseActivitiesVisitsDays(t,e,i,s,r){return a=>{var c={};return a.forEach((t=>{var e="".concat(t.activity_type,"_").concat(t.activity_id);t.group_id>0&&(e+="_".concat(t.group_id)),c[e]=this._emptyDays(i);var r=t.data.length;return t.data.slice(r-i,r+1).forEach(((t,i)=>c[e][i]=t["".concat(s,"count")]||0))})),t[e]=c,r(c)}}courseVisitsCustomRange(t,e,i,s,c,n){var o=(new Date).getTimezoneOffset()/-60,u="courses/".concat(t,"/user-visits/visits?start=").concat(e,"&end=").concat(i,"&split=").concat(s,"&timezone_offset=").concat(o);c&&(u="".concat(u,"&activity_type=").concat(c));var h=this._query(u);return a.when(h).then((function(t){var e={};return r.map(t,((t,i)=>e[i]={visits:t.visits,visitors:t.visitor_ids.length})),n(e)}),(()=>n({})))}courseActivitiesVisitsCustomRange(t,e,i,s,r,c){var n=(new Date).getTimezoneOffset()/-60,u="courses/".concat(t,"/activities/user-visits/visits?start=").concat(e,"&end=").concat(i,"&split=").concat(s,"&timezone_offset=").concat(n);r&&(u="".concat(u,"&activity_type=").concat(r));var h=this._query(u);return a.when(h).then((function(t){var e,i={},s=o(t);try{for(s.s();!(e=s.n()).done;){var r=e.value;i[r.activity_id]=r.visits}}catch(t){s.e(t)}finally{s.f()}return c(i)}),(()=>c({})))}courseUsersVisitsCustomRange(t,e,i,s,r,c){var n=(new Date).getTimezoneOffset()/-60,u="courses/".concat(t,"/users/user-visits/visits?start=").concat(e,"&end=").concat(i,"&split=").concat(s,"&timezone_offset=").concat(n);r&&(u="".concat(u,"&activity_type=").concat(r));var h=this._query(u);return a.when(h).then((function(t){var e,i={},s=o(t);try{for(s.s();!(e=s.n()).done;){var r=e.value;i[r.user_id]=r.visits}}catch(t){s.e(t)}finally{s.f()}return c(i)}),(()=>c({})))}userCourseActivitiesVisitsDays(t,e,i,s){var r="".concat(t,"_").concat(e,"_").concat(i);if(!(r in this.userCourseActivitiesVisitsDaysCache)){var c=this._onGetCourseActivitiesVisitsDays(this.userCourseActivitiesVisitsDaysCache,r,i,"",s),n=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?group_by=activity,group,type&time_restrict=day"));return a.when(n).then(c,(()=>s([])))}s(this.userCourseActivitiesVisitsDaysCache[r])}courseActivitiesVisitsDays(t,e,i,s){var r="".concat(t,"_").concat(e);if(!(r in this.courseActivitiesVisitsDaysCache)){var c=i?"student_":"",n=this._onGetCourseActivitiesVisitsDays(this.courseActivitiesVisitsDaysCache,r,e,c,s),o=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=day&group_by=activity,group,type"));return a.when(o).then(n,(()=>s([])))}s(this.courseActivitiesVisitsDaysCache[r])}_onGetCourseActivitiesVisitsTodayOrYear(t,e,i,s){return function(r){var a={};return r.forEach((function(t){var e="".concat(t.activity_type,"_").concat(t.activity_id);return t.group_id>0&&(e+="_".concat(t.group_id)),a[e]=t.data.map((t=>t["".concat(i,"count")]||0))})),t[e]=a,s(a)}}userCourseActivitiesVisitsToday(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.userCourseActivitiesVisitsTodayCache)){var r=this._onGetCourseActivitiesVisitsTodayOrYear(this.userCourseActivitiesVisitsTodayCache,s,"",i),c=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?time_restrict=hour&group_by=activity,group,type"));return a.when(c).then(r,(()=>i([])))}i(this.userCourseActivitiesVisitsTodayCache[s])}courseActivitiesVisitsToday(t,e,i){if(!(t in this.courseActivitiesVisitsTodayCache)){var s=e?"student_":"",r=this._onGetCourseActivitiesVisitsTodayOrYear(this.courseActivitiesVisitsTodayCache,t,s,i),c=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=hour&group_by=activity,group,type"));return a.when(c).then(r,(()=>i([])))}i(this.courseActivitiesVisitsTodayCache[t])}userCourseActivitiesVisitsYear(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.userCourseActivitiesVisitsYearCache)){var r=this._onGetCourseActivitiesVisitsTodayOrYear(this.userCourseActivitiesVisitsYearCache,s,"",i),c=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?time_restrict=month&group_by=activity,group,type"));return a.when(c).then(r,(()=>i([])))}i(this.userCourseActivitiesVisitsYearCache[s])}courseActivitiesVisitsYear(t,e,i){if(!(t in this.courseActivitiesVisitsYearCache)){var s=e?"student_":"",r=this._onGetCourseActivitiesVisitsTodayOrYear(this.courseActivitiesVisitsYearCache,t,s,i),c=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=month&group_by=activity,group,type"));return a.when(c).then(r,(()=>i([])))}i(this.courseActivitiesVisitsYearCache[t])}userCourseVisitsDays(t,e,i,s){var r="".concat(t,"_").concat(e,"_").concat(i);if(!(r in this.userCourseVisitsDaysCache)){var c=this._onVisitsDaysQuerySuccess(this.userCourseVisitsDaysCache,r,i,"",(t=>s(t.visits||[]))),n=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?time_restrict=day"));return a.when(n).then(c,(()=>s({})))}s(this.userCourseVisitsDaysCache[r].visits)}courseVisitsDays(t,e,i,s){var r="".concat(t,"_").concat(e);if(!(r in this.courseVisitsDaysCache)){var c=i?"student_":"",n=this._onVisitsDaysQuerySuccess(this.courseVisitsDaysCache,r,e,c,s),o=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=day"));return a.when(o).then(n,(()=>s({})))}s(this.courseVisitsDaysCache[r])}userCourseVisitsYear(t,e,i){var s="".concat(t,"_").concat(e);if(!this.userCourseVisitsYearCache[s]){var r=this._onVisitsYearQuerySuccess(this.userCourseVisitsYearCache,s,"student_",(t=>i(t.visits||[]))),c=this._query("courses/".concat(t,"/users/").concat(e,"/user-visits/metrics?time_restrict=month"));return a.when(c).then(r,(()=>i({})))}i(this.userCourseVisitsYearCache[s].visits)}courseVisitsYear(t,e,i){if(!(t in this.courseVisitsYearCache)){var s=e?"student_":"",r=this._onVisitsYearQuerySuccess(this.courseVisitsYearCache,t,s,i),c=this._query("courses/".concat(t,"/user-visits/metrics?time_restrict=month"));return a.when(c).then(r,(()=>i({})))}i(this.courseVisitsYearCache[t])}departmentVisits(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;if(!(t in this.departmentVisitsCache)){var s=this._onVisitsQuerySuccess(this.departmentVisitsCache,"count",t,i),r={dep_ids:e.toString()},c=this._query("deps/".concat(t,"/user-visits/metrics"),null,r);return a.when(c).then(s,(()=>i(0)))}i(this.departmentVisitsCache[t])}departmentVisitsDays(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3?arguments[3]:void 0,r="".concat(t,"_").concat(i);if(!(r in this.departmentVisitsDaysCache)){var c=this._onVisitsDaysQuerySuccess(this.departmentVisitsDaysCache,r,i,"",s),n={dep_ids:e.toString()},o=this._query("deps/".concat(t,"/user-visits/metrics?time_restrict=day"),null,n);return a.when(o).then(c,(()=>s({})))}s(this.departmentVisitsDaysCache[r])}departmentVisitsToday(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;if(!(t in this.departmentVisitsTodayCache)){var s=this._onVisitsTodayQuerySuccess(this.departmentVisitsTodayCache,t,"",i),r={dep_ids:e.toString()},c=this._query("deps/".concat(t,"/user-visits/metrics?time_restrict=hour"),null,r);return a.when(c).then(s,(()=>i({})))}i(this.departmentVisitsTodayCache[t])}departmentVisitsYear(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;if(!(t in this.departmentVisitsYearCache)){var s=this._onVisitsYearQuerySuccess(this.departmentVisitsYearCache,t,"",i),r={dep_ids:e.toString()},c=this._query("deps/".concat(t,"/user-visits/metrics?time_restrict=month"),null,r);return a.when(c).then(s,(()=>i({})))}i(this.departmentVisitsYearCache[t])}orgVisits(t,e){if(!(t in this.orgVisitsCache)){var i=this._onVisitsQuerySuccess(this.orgVisitsCache,"count",t,e),s=this._query("orgs/".concat(t,"/user-visits/metrics"),!0);return a.when(s).then(i,(()=>e(0)))}e(this.orgVisitsCache[t])}orgVisitsDays(t,e,i){var r="".concat(t,"_").concat(e);if(!(r in this.orgVisitsDaysCache)){var c=this._query("orgs/".concat(t,"/user-visits/metrics?time_restrict=day"),!0);return a.when(c).then((t=>{var a={visits:this._emptyDays(e),visitors:this._emptyDays(e)},c=s(s().format("YYYY-MM-DD")),n=c.clone().add(1-e,"days");return(t=this._filterVisitsByDate(t,n,c)).forEach((function(t,e){var i=t.student_count?t.student_count:0,s=t.teacher_count?t.teacher_count:0;a.visits[e]=i+s;var r=t.student_distinct?t.student_distinct:0,c=t.teacher_distinct?t.teacher_distinct:0;a.visitors[e]=r+c})),this.orgVisitsDaysCache[r]=a,i(a)}),(()=>i({})))}i(this.orgVisitsDaysCache[r])}orgVisitsByBrowserDays(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.orgVisitsByBrowserCache)){var r=this._query("orgs/".concat(t,"/user-visits/browsers?days=").concat(e),!0);return a.when(r).then((t=>(this.orgVisitsDaysCache[s]=t,i(t))),(()=>i(0)))}i(this.orgVisitsByBrowserCache[s])}orgVisitsToday(t,e){if(!(t in this.orgVisitsTodayCache)){var i=this._onVisitsTodayQuerySuccess(this.orgVisitsTodayCache,t,"",e),s=this._query("orgs/".concat(t,"/user-visits/metrics?time_restrict=hour"),!0);return a.when(s).then(i,(()=>e({})))}e(this.orgVisitsTodayCache[t])}orgVisitsYear(t,e){if(!(t in this.orgVisitsYearCache)){var i=this._onVisitsYearQuerySuccess(this.orgVisitsYearCache,t,"",e),s=this._query("orgs/".concat(t,"/user-visits/metrics?time_restrict=month"),!0);return a.when(s).then(i,(()=>e({})))}e(this.orgVisitsYearCache[t])}orgBrowserVisitsByDateRange(t,e,i,s){var r="".concat(t,"_").concat(e,"_").concat(i);if(!(r in this.orgVisitsByDateRangeBrowserCache)){var c=this._query("orgs/".concat(t,"/user-visits/date-range/browsers?start_date=").concat(e,"&end_date=").concat(i));return a.when(c).then((t=>(this.orgVisitsDaysCache[r]=t,s(t))),(()=>s(0)))}s(this.orgVisitsByDateRangeBrowserCache[r])}orgVisitsByDateRange(t,e,i,r){var c="".concat(t,"_").concat(e,"_").concat(i);if(!(c in this.orgVisitsDateRangeCache)){var n=this._query("orgs/".concat(t,"/user-visits/metrics?time_restrict=date-range&start_date=").concat(e,"&end_date=").concat(i));return a.when(n).then((t=>{var a={visits:[],visitors:[]};return(t=this._filterVisitsByDate(t,s(e),s(i))).forEach((function(t,e){return a.visits[e]=t.count||0,a.visitors[e]=t.distinct||0})),this.orgVisitsDateRangeCache[c]=a,r(a)}),(()=>r({})))}r(this.orgVisitsDateRangeCache[c])}_onBulletinVisitsQuerySuccess(t,e,i,s,r){return a=>{var c=s,n=a.length;return a.slice(n-i,n+1).forEach(((t,e)=>c[e]=t.view_count)),t[e]=c,r(c)}}bulletinVisitsDays(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.bulletinVisitsDaysCache)){var r=this._emptyDays(e),c=this._onBulletinVisitsQuerySuccess(this.bulletinVisitsDaysCache,s,e,r,i),n=this._query("courses/".concat(t,"/bulletins/histogram?time_restrict=day"));return a.when(n).then(c,(()=>i([])))}i(this.bulletinVisitsDaysCache[s])}bulletinVisitsToday(t,e){if(!(t in this.bulletinVisitsTodayCache)){var i=this._emptyDay(),s=this._onBulletinVisitsQuerySuccess(this.bulletinVisitsTodayCache,t,24,i,e),r=this._query("courses/".concat(t,"/bulletins/histogram?time_restrict=hour"));return a.when(r).then(s,(()=>e([])))}e(this.bulletinVisitsTodayCache[t])}bulletinVisitsYear(t,e){if(!(t in this.bulletinVisitsYearCache)){var i=this._emptyYear(),s=this._onBulletinVisitsQuerySuccess(this.bulletinVisitsYearCache,t,12,i,e),r=this._query("courses/".concat(t,"/bulletins/histogram?time_restrict=month"));return a.when(r).then(s,(()=>e([])))}e(this.bulletinVisitsYearCache[t])}bulletinVisitsCustomRange(t,e,i,s,r){var c="".concat(t,"_").concat(e,"_").concat(i);if(!(c in this.bulletinVisitsDateRangeCache)){var n=(new Date).getTimezoneOffset()/-60,o=this._query("courses/".concat(t,"/bulletins/custom-time-range?start=").concat(e,"&end=").concat(i,"&split=").concat(s,"&timezone_offset=").concat(n));return a.when(o).then((t=>(this.bulletinVisitsDateRangeCache[c]=t,r(t))),(()=>r([])))}r(this.bulletinVisitsDateRangeCache[c])}bulletinGroupByVisits(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.bulletinVisitsCache)){var c=this._query("courses/".concat(t,"/bulletins/visit?group_by=").concat(e));return a.when(c).then((t=>{var e={};return r.map(t,(t=>e[t.bulletin_id]={view_count:t.data.view_count,user_distinct:t.data.user_distinct})),this.bulletinVisitsCache[s]=e,i(e)}),(()=>i([])))}i(this.bulletinVisitsCache[s])}bulletinVisitsStat(t,e,i){var s="".concat(t,"_").concat(e);if(!(s in this.bulletinVisitsStatCache)){var r=this._query("courses/".concat(t,"/bulletins/").concat(e,"/users/visits"));return a.when(r).then((t=>(this.bulletinVisitsStatCache[s]=t,i(t))),(()=>i([])))}i(this.bulletinVisitsStatCache[s])}_query(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s="".concat(this.url,"/api/").concat(t);return e&&this.enableMgsQueryCache&&(s="/anonymous-api/metric-cache/".concat(t)),a.ajax({type:"GET",url:s,dataType:"json",data:i})}}window.statisticsSettings&&(window.stv=new d(window.statisticsSettings))}}]);